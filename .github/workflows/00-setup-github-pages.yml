# 00-setup-github-pages.yml
name: 00-setup-github-pages

# Trigger the workflow when this file is changed
# and on manual deploy

# YOU WILL NEED to setup PAT secret in the org or repo settings.
# A fine grained token WILL NOT WORK.  It must be a classic token with repo and pages scope.

on:
  push:
    branches: [ main ]
    paths: [.github/workflows/00-setup-github-pages.yml]
  workflow_dispatch:


# Build the site using `npm run build`
# Deploy the contents of the `build` directory to the `gh-pages` branch

permissions:
    contents: write
    pages: write

jobs:
    setup-github-pages:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
            - name: Create gh-pages branch if not exists
              env:
                GITHUB_TOKEN: ${{ secrets.PAT }} 
              run: |
                    echo "Checking if gh-pages branch exists for repository: ${{ github.repository}}"
                    if git ls-remote --exit-code --heads origin gh-pages; then
                        echo "gh-pages branch already exists for repository: ${{ github.repository}}"
                    else
                        echo "Creating gh-pages branch for repository: ${{ github.repository}}"
                        git checkout --orphan gh-pages
                        git rm -rf .
                        git commit --allow-empty -m "Initial commit on gh-pages branch"
                        git push origin gh-pages
                        if [ $? -ne 0 ]; then
                            echo "Failed to create gh-pages branch for repository: $repo"
                            exit 1
                        fi
                        echo "gh-pages branch created for repository: ${{ github.repository}}"
                    fi
            - name: Enable Github Pages
              env:
                GITHUB_TOKEN: ${{ secrets.PAT }} 
                REPO: ${{ github.repository }}
              run: |
                    echo "Configuring GitHub Pages for $REPO"

                    # Force Pages source to gh-pages branch
                    curl -sS -L -f -X PUT \
                        -H "Accept: application/vnd.github+json" \
                        -H "Authorization: Bearer $GITHUB_TOKEN " \
                        -H "X-GitHub-Api-Version: 2022-11-28" \
                        https://api.github.com/repos/$REPO/pages \
                        -d '{"source":{"branch":"gh-pages","path":"/"},"build_type": "legacy"}'

                    # Verify configuration
                    CONFIG=$(curl -sS -L -f \
                        -H "Accept: application/vnd.github+json" \
                        -H "Authorization: Bearer $GITHUB_TOKEN " \
                        -H "X-GitHub-Api-Version: 2022-11-28" \
                        https://api.github.com/repos/$REPO/pages)

                    echo "Current Pages config: $CONFIG"

                    BRANCH=$(echo "$CONFIG" | jq -r '.source.branch')
                    PATH=$(echo "$CONFIG" | jq -r '.source.path')
                    BUILD_TYPE=$(echo "$CONFIG" | jq -r '.build_type')

                    if [ "$BRANCH" != "gh-pages" ] || [ "$PATH" != "/" ] || [ "$BUILD_TYPE" != "legacy" ]; then
                        echo "❌ GitHub Pages is NOT configured correctly (branch=$BRANCH, path=$PATH, build_type=$BUILD_TYPE)"
                        exit 1
                    else
                        echo "✅ GitHub Pages is correctly configured on gh-pages /"
                    fi
            - name: Set repo in "about" section 
              env:
                GITHUB_TOKEN: ${{ secrets.PAT }} 
                REPO: ${{ github.repository }}
                OWNER: ${{ github.repository_owner }}
                REPO_NAME: ${{ github.event.repository.name }}
              run: |
                    echo "Setting up github pages site on about page for repository: $repo"
                    curl -sS -f -X PATCH \
                        -H "Accept: application/vnd.github+json" \
                        -H "Content-Type: application/json" \
                        -H "Authorization: Bearer $GITHUB_TOKEN" \
                        -H "X-GitHub-Api-Version: 2022-11-28" \
                        https://api.github.com/repos/$REPO \
                        -d "{\"homepage\":\"https://$OWNER.github.io/$REPO_NAME\"}"
                    if [ $? -ne 0 ]; then
                        echo "Failed to set github pages site for repository: $REPO"
                        exit 1
                    fi
                    echo "GitHub Pages set on about page for repository: $REPO"
